{
  RTMPTConnection client=getClient(req);
  if (client == null) {
    handleBadRequest("Unknown client.",resp);
    return;
  }
 else   if (client.getState().getState() == RTMP.STATE_DISCONNECTED) {
    removeConnection(client.getId());
    handleBadRequest("Connection already closed.",resp);
    return;
  }
  client.setServletRequest(req);
  int length=req.getContentLength();
  ByteBuffer data=ByteBuffer.allocate(length);
  ServletUtils.copy(req.getInputStream(),data.asOutputStream());
  data.flip();
  List messages=client.decode(data);
  data.release();
  data=null;
  if (messages == null || messages.isEmpty()) {
    returnMessage(client.getPollingDelay(),resp);
    return;
  }
  for (  Object message : messages) {
    try {
      handler.messageReceived(client,client.getState(),message);
    }
 catch (    Exception e) {
      log.error("Could not process message.",e);
    }
  }
  returnPendingMessages(client,resp);
}
