{
  final ManagerResponse response;
  final String responseType=(String)attributes.get(RESPONSE_KEY);
  if (RESPONSE_TYPE_ERROR.equalsIgnoreCase(responseType)) {
    response=new ManagerError();
  }
 else   if (responseClass == null) {
    response=new ManagerResponse();
  }
 else {
    try {
      response=responseClass.newInstance();
    }
 catch (    Exception ex) {
      logger.error("Unable to create new instance of " + responseClass.getName(),ex);
      return null;
    }
  }
  setAttributes(response,attributes,ignoredAttributes);
  if (response instanceof CommandResponse) {
    final CommandResponse commandResponse=(CommandResponse)response;
    final List<String> result=new ArrayList<String>();
    for (    String resultLine : ((String)attributes.get(ManagerReader.COMMAND_RESULT_RESPONSE_KEY)).split("\n")) {
      if (!resultLine.equals("--END COMMAND--") && !resultLine.equals(" --END COMMAND--")) {
        result.add(resultLine);
      }
    }
    commandResponse.setResult(result);
  }
  if (response.getResponse() != null && attributes.get(PROXY_RESPONSE_KEY) != null) {
    response.setResponse((String)attributes.get(PROXY_RESPONSE_KEY));
  }
  response.setAttributes(new HashMap<String,Object>(attributes));
  return response;
}
