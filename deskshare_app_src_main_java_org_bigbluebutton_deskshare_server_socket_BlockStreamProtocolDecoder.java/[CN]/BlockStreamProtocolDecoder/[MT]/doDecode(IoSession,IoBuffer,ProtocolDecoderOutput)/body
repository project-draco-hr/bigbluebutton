{
  try {
    if (in.remaining() < 10)     return false;
    byte[] header=new byte[HEADER.length];
    int start=in.position();
    in.get(header,0,HEADER.length);
    if (!Arrays.equals(header,HEADER)) {
      log.info("Closing session. Invalid header.");
      closeSession(session,out);
    }
    int messageLength=in.getInt();
    if (in.remaining() < messageLength) {
      in.position(start);
      return false;
    }
    decodeMessage(session,in,out);
    return true;
  }
 catch (  Exception e) {
    log.info("Closing session. Too many corrupt packets.");
    closeSession(session,out);
    return true;
  }
}
