{
  if (requestedCapacity <= buf.buf().capacity()) {
    return;
  }
  if (buf.isDerived()) {
    throw new IllegalStateException("Derived buffers cannot be expanded.");
  }
  int newCapacity=MINIMUM_CAPACITY;
  while (newCapacity < requestedCapacity) {
    newCapacity<<=1;
  }
  UnexpandableByteBuffer oldBuf=this.buf;
  UnexpandableByteBuffer newBuf=allocate0(newCapacity,isDirect());
  newBuf.buf().clear();
  newBuf.buf().order(oldBuf.buf().order());
  int pos=oldBuf.buf().position();
  int limit=oldBuf.buf().limit();
  oldBuf.buf().clear();
  newBuf.buf().put(oldBuf.buf());
  newBuf.buf().position(0);
  newBuf.buf().limit(limit);
  newBuf.buf().position(pos);
  this.buf=newBuf;
  oldBuf.release();
}
