{
  while (!request.acquiredStack.isEmpty()) {
    TokenRequestContext requestContext=request.acquiredStack.pop();
    BWContext context=contextMap.get(requestContext.bc);
    if (context != null) {
synchronized (context) {
        if (context.bwConfig != null) {
          if (context.bwConfig[3] >= 0) {
            if (request.type == TokenRequestType.BEST_EFFORT) {
              context.tokenRc[3]+=requestContext.acquiredToken - request.requestToken;
            }
 else {
              context.tokenRc[3]+=requestContext.acquiredToken;
            }
          }
 else {
            if (context.bwConfig[request.channel] >= 0) {
              if (request.type == TokenRequestType.BEST_EFFORT) {
                context.tokenRc[request.channel]+=requestContext.acquiredToken - request.requestToken;
              }
 else {
                context.tokenRc[request.channel]+=requestContext.acquiredToken;
              }
            }
          }
        }
      }
    }
  }
}
