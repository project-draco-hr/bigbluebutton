{
  log.debug("Servicing AMF");
  try {
    RemotingPacket packet=decodeRequest(req);
    if (packet == null) {
      log.error("Packet should not be null");
      return;
    }
    final IGlobalScope global=getGlobalScope(req);
    final IContext context=global.getContext();
    final IScope scope=context.resolveScope(global,packet.getScopePath());
    IRemotingConnection conn=new RemotingConnection(req,scope,packet);
    req.setAttribute(CONNECTION,conn);
    try {
      Red5.setConnectionLocal(conn);
      handleRemotingPacket(req,context,scope,packet);
      resp.setStatus(HttpServletResponse.SC_OK);
      resp.setContentType(APPLICATION_AMF);
      sendResponse(resp,packet);
    }
  finally {
      req.removeAttribute(CONNECTION);
    }
  }
 catch (  Exception e) {
    log.error("Error handling remoting call",e);
    resp.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
  }
}
