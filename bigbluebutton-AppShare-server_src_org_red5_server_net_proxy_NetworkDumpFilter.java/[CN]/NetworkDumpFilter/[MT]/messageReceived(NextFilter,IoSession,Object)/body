{
  if (message instanceof ByteBuffer) {
    ByteBuffer out=(ByteBuffer)message;
    if (headers != null) {
      ByteBuffer header=ByteBuffer.allocate(12);
      header.putLong(System.currentTimeMillis());
      header.putInt(out.limit() - out.position());
      header.flip();
      headers.write(header.buf());
    }
    if (raw != null) {
      raw.write(out.asReadOnlyBuffer().buf());
    }
  }
  next.messageReceived(session,message);
}
