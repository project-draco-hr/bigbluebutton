{
  expect(socketConnectionFacade.readLine()).andReturn("Asterisk Call Manager/1.0");
  expect(socketConnectionFacade.readLine()).andReturn(null);
  replay(socketConnectionFacade);
  managerReader.setSocket(socketConnectionFacade);
  managerReader.run();
  verify(socketConnectionFacade);
  assertEquals("not exactly two events dispatched",2,dispatcher.dispatchedEvents.size());
  assertEquals("first event must be a ProtocolIdentifierReceivedEvent",ProtocolIdentifierReceivedEvent.class,dispatcher.dispatchedEvents.get(0).getClass());
  assertEquals("ProtocolIdentifierReceivedEvent contains incorrect protocol identifier","Asterisk Call Manager/1.0",((ProtocolIdentifierReceivedEvent)dispatcher.dispatchedEvents.get(0)).getProtocolIdentifier());
  assertEquals("ProtocolIdentifierReceivedEvent contains incorrect dateReceived",now,dispatcher.dispatchedEvents.get(0).getDateReceived());
  assertEquals("second event must be a DisconnectEvent",DisconnectEvent.class,dispatcher.dispatchedEvents.get(1).getClass());
  assertEquals("DisconnectEvent contains incorrect dateReceived",now,dispatcher.dispatchedEvents.get(1).getDateReceived());
}
