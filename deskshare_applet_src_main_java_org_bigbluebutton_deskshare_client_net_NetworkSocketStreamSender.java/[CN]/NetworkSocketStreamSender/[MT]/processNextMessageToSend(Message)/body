{
  if (message.getMessageType() == Message.MessageType.BLOCK) {
    ByteArrayOutputStream dataToSend=new ByteArrayOutputStream();
    dataToSend.reset();
    BlockStreamProtocolEncoder.encodeRoomAndSequenceNumber(room,seqNumGenerator.getNext(),dataToSend);
    Integer[] changedBlocks=((BlockMessage)message).getBlocks();
    BlockStreamProtocolEncoder.numBlocksChanged(changedBlocks.length,dataToSend);
    String blocksStr="Encoding ";
    for (int i=0; i < changedBlocks.length; i++) {
      blocksStr+=" " + (Integer)changedBlocks[i];
      EncodedBlockData block=retriever.getBlockToSend((Integer)changedBlocks[i]);
      BlockVideoData bv=new BlockVideoData(room,block.getPosition(),block.getVideoData(),false);
      BlockStreamProtocolEncoder.encodeBlock(bv,dataToSend);
    }
    sendHeader(BlockStreamProtocolEncoder.encodeHeaderAndLength(dataToSend));
    sendToStream(dataToSend);
    for (int i=0; i < changedBlocks.length; i++) {
      retriever.blockSent((Integer)changedBlocks[i]);
    }
  }
 else   if (message.getMessageType() == Message.MessageType.CURSOR) {
    CursorMessage msg=(CursorMessage)message;
    sendCursor(msg.getMouseLocation(),msg.getRoom());
  }
 else   if (message.getMessageType() == Message.MessageType.POISON) {
    System.out.println("Received poison message.");
    try {
      ByteArrayOutputStream dataToSend=new ByteArrayOutputStream();
      dataToSend.reset();
      BlockStreamProtocolEncoder.encodeEndStreamMessage(room,dataToSend,seqNumGenerator.getNext());
      sendHeader(BlockStreamProtocolEncoder.encodeHeaderAndLength(dataToSend));
      sendToStream(dataToSend);
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
 finally {
      processMessages=false;
      System.out.println("Disconnected socket stream");
    }
  }
}
