{
  super.sessionOpened(session);
  RTMP rtmp=(RTMP)session.getAttribute(ProtocolState.SESSION_KEY);
  if (rtmp.getMode() == RTMP.MODE_CLIENT) {
    if (log.isDebugEnabled()) {
      log.debug("Handshake 1st phase");
    }
    ByteBuffer out=ByteBuffer.allocate(Constants.HANDSHAKE_SIZE + 1);
    out.put((byte)0x03);
    out.fill((byte)0x00,Constants.HANDSHAKE_SIZE);
    out.flip();
    session.write(out);
  }
 else {
    final RTMPMinaConnection conn=(RTMPMinaConnection)session.getAttachment();
    handler.connectionOpened(conn,rtmp);
  }
}
