{
  final RTMP rtmp=(RTMP)state;
  if (rtmp.getMode() == RTMP.MODE_SERVER) {
    if (rtmp.getState() != RTMP.STATE_HANDSHAKE) {
      log.warn("Raw buffer after handshake, something odd going on");
    }
    log.debug("Handshake 2nd phase - size: {}",in.remaining());
    ByteBuffer out=ByteBuffer.allocate((Constants.HANDSHAKE_SIZE * 2) + 1);
    out.put((byte)0x03);
    out.putInt(0x01);
    out.fill((byte)0x00,Constants.HANDSHAKE_SIZE - 4);
    out.put(in);
    out.flip();
    rtmp.setHandshake(out,9,Constants.HANDSHAKE_SIZE - 8);
    session.write(out);
  }
 else {
    log.debug("Handshake 3d phase - size: {}",in.remaining());
    in.skip(1);
    ByteBuffer out=ByteBuffer.allocate(Constants.HANDSHAKE_SIZE);
    int limit=in.limit();
    in.limit(in.position() + Constants.HANDSHAKE_SIZE);
    out.put(in);
    out.flip();
    in.limit(limit);
    in.skip(Constants.HANDSHAKE_SIZE);
    session.write(out);
  }
}
