{
  if (!(message instanceof IStreamData)) {
    throw new RuntimeException("expected IStreamData but got " + message.getClass() + " (type "+ message.getDataType()+ ")");
  }
  final long now=System.currentTimeMillis();
  if (lastMessage != null) {
    final long delta=now - playbackStart;
    final long buffer=getClientBufferDuration();
    final long buffered=lastMessage.getTimestamp() - delta;
    if (log.isDebugEnabled()) {
      log.debug("okayToSendMessage: " + lastMessage.getTimestamp() + " "+ delta+ " "+ buffered+ " "+ buffer);
    }
    if (buffer > 0 && buffered > buffer) {
      return false;
    }
  }
  long pending=pendingMessages();
  if (bufferCheckInterval > 0 && now >= nextCheckBufferUnderrun) {
    if (pending > underrunTrigger) {
      sendInsufficientBandwidthStatus(currentItem);
    }
    nextCheckBufferUnderrun=now + bufferCheckInterval;
  }
  if (pending > underrunTrigger) {
    return false;
  }
  if (((IStreamData)message).getData() == null) {
    return true;
  }
  final int size=((IStreamData)message).getData().limit();
  if (message instanceof VideoData) {
    if (needCheckBandwidth && !videoBucket.acquireTokenNonblocking(size,this)) {
      isWaitingForToken=true;
      return false;
    }
  }
 else   if (message instanceof AudioData) {
    if (needCheckBandwidth && !audioBucket.acquireTokenNonblocking(size,this)) {
      isWaitingForToken=true;
      return false;
    }
  }
  return true;
}
