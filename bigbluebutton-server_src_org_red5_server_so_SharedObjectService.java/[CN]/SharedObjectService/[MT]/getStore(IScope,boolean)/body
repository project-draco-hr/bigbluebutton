{
  IPersistenceStore store;
  if (!persistent) {
    if (!scope.hasAttribute(SO_TRANSIENT_STORE)) {
      store=new RamPersistence(scope);
      scope.setAttribute(SO_TRANSIENT_STORE,store);
      return store;
    }
    return (IPersistenceStore)scope.getAttribute(SO_TRANSIENT_STORE);
  }
  if (!scope.hasAttribute(SO_PERSISTENCE_STORE)) {
    try {
      store=PersistenceUtils.getPersistenceStore(scope,persistenceClassName);
      log.info("Created persistence store " + store + " for shared objects.");
    }
 catch (    Exception err) {
      log.error("Could not create persistence store for shared objects, falling back to Ram persistence.",err);
      store=new RamPersistence(scope);
    }
    scope.setAttribute(SO_PERSISTENCE_STORE,store);
    return store;
  }
  return (IPersistenceStore)scope.getAttribute(SO_PERSISTENCE_STORE);
}
