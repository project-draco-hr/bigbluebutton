{
  if (videoStream == null) {
    throw new Exception("No video output stream (Is imageWidth > 0 && imageHeight > 0 and has start() been called?)");
  }
  int ret;
  if (data == null) {
  }
 else {
    int step=3 * width;
    if (avCodecContext.pix_fmt() != pixelFormat || avCodecContext.width() != width || avCodecContext.height() != height) {
      img_convert_ctx=sws_getCachedContext(img_convert_ctx,width,height,pixelFormat,avCodecContext.width(),avCodecContext.height(),avCodecContext.pix_fmt(),SWS_BILINEAR,null,null,(DoublePointer)null);
      if (img_convert_ctx == null) {
        throw new Exception("sws_getCachedContext() error: Cannot initialize the conversion context.");
      }
      avpicture_fill(new AVPicture(tmp_picture),data,pixelFormat,width,height);
      avpicture_fill(new AVPicture(picture),picture_buf,avCodecContext.pix_fmt(),avCodecContext.width(),avCodecContext.height());
      tmp_picture.linesize(0,step);
      sws_scale(img_convert_ctx,new PointerPointer(tmp_picture),tmp_picture.linesize(),0,height,new PointerPointer(picture),picture.linesize());
    }
 else {
      avpicture_fill(new AVPicture(picture),data,pixelFormat,width,height);
      picture.linesize(0,step);
    }
  }
  if ((outFormat.flags() & AVFMT_RAWPICTURE) != 0) {
    if (data == null) {
      return false;
    }
    av_init_packet(videoPacket);
    videoPacket.flags(videoPacket.flags() | AV_PKT_FLAG_KEY);
    videoPacket.stream_index(videoStream.index());
    videoPacket.data(new BytePointer(picture));
    videoPacket.size(Loader.sizeof(AVPicture.class));
  }
 else {
    av_init_packet(videoPacket);
    videoPacket.data(videoOutBuf);
    videoPacket.size(video_outbuf_size);
    picture.quality(avCodecContext.global_quality());
    if ((ret=avcodec_encode_video2(avCodecContext,videoPacket,data == null ? null : picture,got_video_packet)) < 0) {
      throw new Exception("avcodec_encode_video2() error " + ret + ": Could not encode video packet.");
    }
    picture.pts(picture.pts() + 1);
    if (got_video_packet[0] != 0) {
      if (videoPacket.pts() != AV_NOPTS_VALUE) {
        videoPacket.pts(av_rescale_q(videoPacket.pts(),avCodecContext.time_base(),videoStream.time_base()));
      }
      if (videoPacket.dts() != AV_NOPTS_VALUE) {
        videoPacket.dts(av_rescale_q(videoPacket.dts(),avCodecContext.time_base(),videoStream.time_base()));
      }
      videoPacket.stream_index(videoStream.index());
    }
 else {
      return false;
    }
  }
synchronized (outFormatContext) {
    if ((ret=av_write_frame(outFormatContext,videoPacket)) < 0) {
      throw new Exception("av_write_frame() error " + ret + " while writing video frame.");
    }
  }
  return (videoPacket.flags() & AV_PKT_FLAG_KEY) == 1;
}
