{
  if (state == State.PLAYING && isPullMode && !isWaitingForToken) {
    if (pendingMessage != null) {
      IRTMPEvent body=pendingMessage.getBody();
      if (!okayToSendMessage(body)) {
        return;
      }
      sendMessage(pendingMessage);
      releasePendingMessage();
    }
 else {
      while (true) {
        IMessage msg=msgIn.pullMessage();
        if (msg == null) {
          stop();
          break;
        }
 else {
          if (msg instanceof RTMPMessage) {
            RTMPMessage rtmpMessage=(RTMPMessage)msg;
            IRTMPEvent body=rtmpMessage.getBody();
            if (!receiveAudio && body instanceof AudioData) {
              ((IStreamData)body).getData().release();
              if (sendBlankAudio) {
                sendBlankAudio=false;
                body=new AudioData();
                if (lastMessage != null) {
                  body.setTimestamp(lastMessage.getTimestamp() - timestampOffset);
                }
 else {
                  body.setTimestamp(-timestampOffset);
                }
                rtmpMessage.setBody(body);
              }
 else {
                continue;
              }
            }
 else             if (!receiveVideo && body instanceof VideoData) {
              ((IStreamData)body).getData().release();
              continue;
            }
            body.setTimestamp(body.getTimestamp() + timestampOffset);
            if (okayToSendMessage(body)) {
              sendMessage(rtmpMessage);
              ((IStreamData)body).getData().release();
            }
 else {
              pendingMessage=rtmpMessage;
            }
            ensurePullAndPushRunning();
            break;
          }
        }
      }
    }
  }
}
