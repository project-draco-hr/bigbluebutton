{
  IBWControllable bc=request.initialBC;
  while (bc != null) {
    BWContext context=contextMap.get(bc);
    if (context == null) {
      rollbackRequest(request);
      return false;
    }
synchronized (context) {
      if (context.bwConfig != null) {
        boolean result;
        if (request.type == TokenRequestType.BLOCKING) {
          result=processBlockingRequest(request,context);
        }
 else         if (request.type == TokenRequestType.NONBLOCKING) {
          result=processNonblockingRequest(request,context);
        }
 else {
          result=processBestEffortRequest(request,context);
        }
        if (!result) {
          if (request.type != TokenRequestType.NONBLOCKING) {
            rollbackRequest(request);
          }
          return false;
        }
      }
      TokenRequestContext requestContext=new TokenRequestContext();
      requestContext.acquiredToken=request.requestToken;
      requestContext.bc=bc;
      request.acquiredStack.push(requestContext);
    }
    bc=bc.getParentBWControllable();
  }
  if (request.type == TokenRequestType.BEST_EFFORT) {
    rollbackRequest(request);
  }
  return true;
}
