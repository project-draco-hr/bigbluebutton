{
  try {
    final ProtocolState state=(ProtocolState)session.getAttribute(ProtocolState.SESSION_KEY);
synchronized (out) {
      final ByteBuffer buf=encode(state,message);
      if (buf != null) {
        out.write(buf);
        out.mergeAll();
        out.flush();
      }
    }
  }
 catch (  Exception ex) {
    log.error("{}",ex);
  }
}
