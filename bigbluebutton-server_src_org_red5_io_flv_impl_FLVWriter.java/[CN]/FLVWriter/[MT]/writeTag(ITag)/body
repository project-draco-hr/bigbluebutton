{
  if (!append && bytesWritten == 0 && tag.getDataType() != ITag.TYPE_METADATA) {
    writeMetadataTag(0,-1,-1);
  }
  out.clear();
  out.put(tag.getDataType());
  IOUtils.writeMediumInt(out,tag.getBodySize());
  IOUtils.writeMediumInt(out,tag.getTimestamp() + offset);
  out.putInt(0x00);
  out.flip();
  bytesWritten+=channel.write(out.buf());
  ByteBuffer bodyBuf=tag.getBody();
  bytesWritten+=channel.write(bodyBuf.buf());
  if (audioCodecId == -1 && tag.getDataType() == ITag.TYPE_AUDIO) {
    bodyBuf.flip();
    byte id=bodyBuf.get();
    audioCodecId=(id & ITag.MASK_SOUND_FORMAT) >> 4;
  }
 else   if (videoCodecId == -1 && tag.getDataType() == ITag.TYPE_VIDEO) {
    bodyBuf.flip();
    byte id=bodyBuf.get();
    videoCodecId=id & ITag.MASK_VIDEO_CODEC;
  }
  duration=Math.max(duration,tag.getTimestamp() + offset);
  out.clear();
  out.putInt(tag.getBodySize() + 11);
  out.flip();
  bytesWritten+=channel.write(out.buf());
  return false;
}
