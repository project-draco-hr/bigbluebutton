{
  BufferedImage resultImage=graphicsConfig.createCompatibleImage(scaleWidth,scaleHeight,Transparency.BITMASK);
  resultImage.setAccelerationPriority(1);
  Graphics2D g2=resultImage.createGraphics();
  if (image.getWidth() < scaleWidth || image.getHeight() < scaleHeight) {
    int imgWidth=image.getWidth();
    int imgHeight=image.getHeight();
    if (imgWidth < scaleWidth && imgHeight < scaleHeight) {
      System.out.println("Screen capture. capture=[" + imgWidth + ","+ imgHeight+ "] scale=["+ resultImage.getWidth()+ ","+ resultImage.getHeight()+ "]");
      g2.drawImage(image,(resultImage.getWidth() - imgWidth) / 2,(resultImage.getHeight() - imgHeight) / 2,imgWidth,imgHeight,null);
    }
 else {
      if (imgWidth > scaleWidth) {
        double ratio=(double)imgHeight / (double)imgWidth;
        imgWidth=scaleWidth;
        imgHeight=(int)((double)imgWidth * ratio);
      }
 else {
        double ratio=(double)imgWidth / (double)imgHeight;
        imgHeight=scaleHeight;
        imgWidth=(int)((double)imgHeight * ratio);
      }
      Image scaledImage=image.getScaledInstance(imgWidth,imgHeight,Image.SCALE_AREA_AVERAGING);
      g2.drawImage(scaledImage,(resultImage.getWidth() - imgWidth) / 2,(resultImage.getHeight() - imgHeight) / 2,imgWidth,imgHeight,null);
    }
  }
 else {
    System.out.println("Both capture sides are greater than the scaled dims. Downscale image.");
    double imgWidth=image.getWidth();
    double imgHeight=image.getHeight();
    if (captureWidth >= captureHeight) {
      System.out.println("fitToWidthAndAdjustHeightToMaintainAspectRatio");
      imgWidth=scaleWidth;
      imgHeight=(double)captureHeight * (double)((double)scaleWidth / (double)captureWidth);
      if (imgHeight > scaleHeight) {
        imgWidth=(double)imgWidth * ((double)scaleHeight / (double)imgHeight);
        imgHeight=scaleHeight;
      }
    }
 else {
      System.out.println("fitToHeightAndAdjustWidthToMaintainAspectRatio");
      imgHeight=scaleHeight;
      imgWidth=(double)captureWidth * (double)((double)scaleHeight / (double)captureHeight);
      if (imgWidth > scaleWidth) {
        imgHeight=(double)imgHeight * (double)((double)scaleWidth / (double)imgWidth);
        imgWidth=scaleWidth;
      }
    }
    Image scaledImage=image.getScaledInstance((int)imgWidth,(int)imgHeight,Image.SCALE_AREA_AVERAGING);
    g2.drawImage(scaledImage,(resultImage.getWidth() - (int)imgWidth) / 2,(resultImage.getHeight() - (int)imgHeight) / 2,(int)imgWidth,(int)imgHeight,null);
  }
  g2.dispose();
  return resultImage;
}
